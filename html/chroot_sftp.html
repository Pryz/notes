<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.6.7" />
<title>How to create a chrooted SFTP platform</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
<link href="css/bootstrap-responsive.min.css" rel="stylesheet" media="screen">
<script type="text/javascript" src="http://code.jquery.com/jquery.js"></script>
<script type="text/javascript" src="js/bootstrap.min.js"></script>
<link rel="stylesheet" href="css/pygments.css" type="text/css">
<style type="text/css">
a:link {
        text-decoration:none !important;
            color:#1C1C1C !important;
}
a:link:hover {
        text-decoration:underline !important;
}
.sort {
        margin:0 0 10px 15px;
}
</style>
<script type="text/javascript">
</script>
</head>
<body >
<div class="container">
<h1>
How to create a chrooted SFTP platform
</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph"><div class="title">Configure chroot sftp</div><p>/etc/ssh/sshd_config</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c">#Subsystem sftp /usr/libexec/openssh/sftp-server</span>
Subsystem   sftp    internal-sftp -l INFO

Match group sftpusers
    ChrootDirectory /sftp/%u
    ForceCommand internal-sftp -l INFO
    X11Forwarding no
    AllowTcpForwarding no
</pre></div></div></div>
<div class="listingblock">
<div class="title">Create new user - script</div>
<div class="content"><div class="highlight"><pre><span class="c">#!/bin/bash</span>


<span class="k">if</span> <span class="o">[[</span> <span class="nv">$EUID</span> -ne 0 <span class="o">]]</span>;<span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;This script must be run as root&quot;</span> 1&gt;&amp;2
        <span class="nb">exit </span>1
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[[</span> <span class="nv">$# </span>-lt 1 <span class="o">]]</span>;<span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;Usage: $0 username&quot;</span>
        <span class="nb">exit </span>1
<span class="k">fi</span>

<span class="nv">USER</span><span class="o">=</span><span class="nv">$1</span>

<span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;$(getent passwd $USER)&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;User already exists.&quot;</span>
        <span class="nb">exit </span>1
<span class="k">fi</span>

<span class="c"># Create the local user</span>
useradd -g sftpusers -s /sbin/nologin -d /sftp/<span class="nv">$USER</span> <span class="nv">$USER</span>
passwd <span class="nv">$USER</span>

<span class="c"># Create user directories</span>
chown root:root /sftp/<span class="nv">$USER</span>
chmod 755 /sftp/<span class="nv">$USER</span>
mkdir /sftp/<span class="nv">$USER</span>/<span class="o">{</span>dev,in,out<span class="o">}</span>
chown <span class="nv">$USER</span>:sftpusers /sftp/<span class="nv">$USER</span>/<span class="o">{</span>in,out<span class="o">}</span>

<span class="c"># Allow access to sftp user</span>
<span class="c"># /!\ set the ACL on $USER directory prevent the user to connect /!\</span>
setfacl -R -m u:sftp:rwx /sftp/<span class="nv">$USER</span>/<span class="o">{</span>in,out<span class="o">}</span>

<span class="c"># Add log device in rsyslog.conf</span>
<span class="nb">echo</span> <span class="s2">&quot;\$AddUnixListenSocket    /sftp/$USER/dev/log&quot;</span> &gt;&gt; /etc/rsyslog.conf

/sbin/service rsyslog restart

<span class="nb">echo</span> <span class="s2">&quot;User $USER created.&quot;</span>
</pre></div></div></div>
<div class="listingblock">
<div class="title">Need other user access to the protected dir</div>
<div class="content"><div class="highlight"><pre>setfacl -R -d -m :u:sftp:rws /sftp/mf*
</pre></div></div></div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
</div>
</div>
</body>
</html>
